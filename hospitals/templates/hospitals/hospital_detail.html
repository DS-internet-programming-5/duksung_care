<style>
    .star {
        cursor: pointer;
    }

    .selected {
        color: gold;
    }

    .div-detail::-webkit-scrollbar {
        display: none;
    }

    .rating i {
        color: lightgrey;
    }
</style>

<div class="offcanvas-header justify-content-end">
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"
            id="offcanvasCloseBtn"></button>
</div>

<div class="div-detail pt-2 pl-2 pr-2 overflow-y-auto" data-latitude="{{ hospital.y }}"
     data-longitude="{{ hospital.x }}">
    <h3 class="text-center">{{ hospital.place_name }}</h3>
    <p class="text-center" style="font-size: 16px; color: gray">{{ hospital.category_name }}</p>
    <ul class="nav nav-tabs justify-content-center" id="reviewTab" role="tablist">
        <li class="nav-item m-0" role="presentation">
            <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail-tab-pane"
                    type="button" role="tab" aria-controls="detail-tab-pane" aria-selected="true">정보
            </button>
        </li>
        <li class="nav-item m-0" role="presentation">
            <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review-tab-pane"
                    type="button" role="tab" aria-controls="review-tab-pane" aria-selected="false">리뷰
            </button>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent" style="padding: 0 20px">
        <div class="tab-pane fade show active p-3 pt-3" id="detail-tab-pane" role="tabpanel"
             aria-labelledby="detail-tab" tabindex="0">
            <p class="text-start" style="font-size: 16px;"><i
                    class="fa-solid fa-location-dot mb-2 mt-3"></i>{{ hospital.address_name }}</p>
            <p class="text-start" style="font-size: 16px;"><i class="fa-regular fa-clock mb-2"></i>영업시간</p>
            <p class="text-start" style="font-size: 16px;"><i class="fa-solid fa-phone mb-2"
                                                              style="color: #000000;"></i>{{ hospital.hospital_phone }}
            </p>
        </div>
        <div class="tab-pane fade pt-3" id="review-tab-pane" role="tabpanel" aria-labelledby="review-tab" tabindex="0">
            <div class="d-flex justify-content-center">
                <a class="link-secondary" data-bs-toggle="collapse" href="#collapseExample" role="button"
                   aria-expanded="false" aria-controls="collapseExample">
                    리뷰작성하기 <i class="fa-solid fa-caret-down"></i>
                </a>
            </div>
            <div class="collapse" id="collapseExample">
                <form id="review-form" method="POST" data-hospital-pk="{{ hospital.pk }}">
                    {% csrf_token %}
                    <textarea class="form-control me-2 mb-3" type="input" placeholder="내용을 입력해주세요." aria-label="Review"
                              name="content" style="height: 200px;"></textarea>
                    <!-- rating 입력받기 -->
                    <div class="make_star d-flex mb-3 justify-content-center">
                        <div class="rating" data-rating="3" style="margin-right: 10px">
                            <i class="fa fa-star fs-2" data-value="1"></i>
                            <i class="fa fa-star fs-2" data-value="2"></i>
                            <i class="fa fa-star fs-2" data-value="3"></i>
                            <i class="fa fa-star fs-2" data-value="4"></i>
                            <i class="fa fa-star fs-2" data-value="5"></i>
                        </div>
                        <select name="hospital_rating" type="number" id="makeStar" style="display: none">
                            <option value="0">0점</option>
                            <option value="1">1점</option>
                            <option value="2">2점</option>
                            <option value="3">3점</option>
                            <option value="4">4점</option>
                            <option value="5">5점</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-outline-primary" type="submit" style="width: 100px">작성</button>
                    </div>

                </form>
            </div>
            <div class="review-list mt-3">
                <!-- 기존 리뷰 목록을 표시할 곳 -->
                {% for r in review_list %}
                    <div class="review">
                        <div class="rating" data-rate="{{ r.hospital_rating }}">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                    </div>
                    <p>{{ r.content }}</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const element = document.querySelector('.div-detail');
        const latitude = element.getAttribute('data-latitude');
        const longitude = element.getAttribute('data-longitude');

        panTo(latitude, longitude);

        // Bootstrap 탭 활성화
        var tab = new bootstrap.Tab(document.getElementById('myTab'));
        tab.show();
    });
</script>
<script>
    $(document).ready(function () {
        $('#review-form').submit(function (e) {
            e.preventDefault();

            var formData = $(this).serialize();
            var hospitalPk = $(this).data('hospital-pk');
            var url = `/hospital/new_review/${hospitalPk}/`;

            console.log(formData);

            $.ajax({
                type: 'POST',
                url: url,
                data: formData,
                success: function (data) {
                    // 리뷰가 성공적으로 추가되면 해당 리뷰를 화면에 동적으로 추가
                    $('.review-list').append(`<div class="review"><div class="rating" data-rate="${data.hospital_rating}">${getStars(data.hospital_rating)}</div></div>`);
                    $('.review-list').append(`<p>${data.content}</p>`);
                    $('#review-form textarea[name="content"]').val('');
                    $('.make_star i').css({color: 'lightgrey'});
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        });
    });

    function getStars(rating) {
        var starsHTML = '';
        for (var i = 0; i < 5; i++) {
            if (i < rating) {
                starsHTML += '<i class="fas fa-star" style="color: #FFC436"></i> ';
            } else {
                starsHTML += '<i class="fas fa-star" style="color: lightgrey"></i> ';
            }
        }
        return starsHTML;
    }
</script>
<script>
    $(function () {
        var rating = $('.review .rating');

        rating.each(function () {
            var targetScore = $(this).attr('data-rate');
            console.log(targetScore);
            $(this).find('i:nth-child(-n+' + targetScore + ')').css({color: '#FFC436'})
        });

        var userScore = $('#makeStar');
        userScore.change(function () {
            var userScoreNum = $(this).val();
            console.log(userScoreNum);
            $('.make_star i').css({color: 'lightgrey'});
            $('.make_star i:nth-child(-n+' + userScoreNum + ')').css({color: '#FFC436'});
        });

        $('.make_star i').click(function () {
            var targetNum = $(this).index() + 1;
            $('.make_star i').css({color: 'lightgrey'});
            var hospitalRatingSelect = $('#makeStar');
            hospitalRatingSelect.val(targetNum);
            $('.make_star i:nth-child(-n+' + targetNum + ')').css({color: '#FFC436'});
        })
    })


</script>